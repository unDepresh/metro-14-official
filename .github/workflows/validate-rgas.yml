name: RGA schema validator
on:
  push:
    branches: [ master, staging, stable ]
  merge_group:
  pull_request_target:
    types: [ opened, reopened, synchronize, ready_for_review ]
  workflow_dispatch:

jobs:
  yaml-schema-validation:
    name: YAML RGA schema validator
    if: github.actor != 'IanComradeBot' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ –ò–ó PR (–Ω–µ –∏–∑ —Ü–µ–ª–µ–≤–æ–π –≤–µ—Ç–∫–∏!)
      - name: Checkout PR code
        uses: actions/checkout@v4.2.2
        with:
          repository: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false
          
      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º Metro-Observers
      - name: Setup private submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN }}
        run: |
          echo "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º..."
          
          if [ -n "$PAT" ] && { 
            [ "${{ github.event_name }}" != "pull_request_target" ] || 
            [ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]; 
          }; then
            echo "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π"
            git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"
          else
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø (PR –∏–∑ —Ñ–æ—Ä–∫–∞ –∏–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞)"
          fi
          
          echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏..."
          if git submodule update --init --recursive; then
            echo "–ü–æ–¥–º–æ–¥—É–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
          else
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–º–æ–¥—É–ª–∏"
            echo "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–æ–¥–º–æ–¥—É–ª—è–º–∏..."
          fi
          
      # 3. –û–±–Ω–æ–≤–ª—è–µ–º RobustToolbox
      - name: Update RobustToolbox
        run: |
          echo "–û–±–Ω–æ–≤–ª—è–µ–º RobustToolbox..."
          if [ -d "RobustToolbox/" ]; then
            cd RobustToolbox
            git submodule update --init --recursive
            cd ..
            echo "RobustToolbox –æ–±–Ω–æ–≤–ª–µ–Ω"
          else
            echo "RobustToolbox –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
      # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ö–µ–º RGA
      - name: Check RGA schemas
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ö–µ–º RGA..."
          
          SCHEMA_PATHS=(
            "Schemas/rga.yml"
            "RobustToolbox/Schemas/rga.yml"
            "Content.Shared/Schemas/rga.yml"
          )
          
          for path in "${SCHEMA_PATHS[@]}"; do
            if [ -f "$path" ]; then
              echo "–°—Ö–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞: $path"
              SCHEMA_PATH="$path"
              break
            fi
          done
          
          if [ -z "$SCHEMA_PATH" ]; then
            echo "–°—Ö–µ–º–∞ rga.yml –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏–∑ –º–µ—Å—Ç:"
            printf '  - %s\n' "${SCHEMA_PATHS[@]}"
            exit 1
          fi
          
          echo "SCHEMA_PATH=$SCHEMA_PATH" >> $GITHUB_ENV
          
      # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ attribution —Ñ–∞–π–ª—ã –≤ PR
      - name: Check changed attribution files
        id: changed_files
        if: github.event_name == 'pull_request_target'
        run: |
          echo "–ò—â–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ attribution —Ñ–∞–π–ª—ã –≤ PR..."
          
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            git remote add pr_head "https://github.com/${{ github.event.pull_request.head.repo.full_name }}.git"
            git fetch pr_head $HEAD_REF
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF pr_head/$HEAD_REF -- "*attributions.yml" "*attributions.yaml" 2>/dev/null || echo "")
          else
            git fetch origin $BASE_REF $HEAD_REF
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF origin/$HEAD_REF -- "*attributions.yml" "*attributions.yaml" 2>/dev/null || echo "")
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ attribution —Ñ–∞–π–ª—ã:"
            echo "$CHANGED_FILES"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ attribution —Ñ–∞–π–ª–∞—Ö"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          
      # 6. –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä RGA —Å—Ö–µ–º
      - name: Validate RGA files
        if: github.event_name != 'pull_request_target' || steps.changed_files.outputs.changed == 'true'
        uses: PaulRitter/yaml-schema-validator@v1
        with:
          schema: ${{ env.SCHEMA_PATH || 'Schemas/rga.yml' }}
          path_pattern: .*attributions.ya?ml$
          validators_path: Schemas/rga_validators.py
          validators_requirements: Schemas/rga_requirements.txt
          
      # 7. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
      - name: Skip if no attribution changes
        if: github.event_name == 'pull_request_target' && steps.changed_files.outputs.changed == 'false'
        run: |
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ attribution —Ñ–∞–π–ª–∞—Ö, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞"
