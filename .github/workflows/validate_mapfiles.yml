name: Map file schema validator

on:
  push:
    branches: [ master, staging, stable ]
  merge_group:
  pull_request_target:  # ‚Üê –ú–µ–Ω—è–µ–º –Ω–∞ pull_request_target –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ–∫—Ä–µ—Ç–∞–º
    types: [ opened, reopened, synchronize, ready_for_review ]
  workflow_dispatch:

jobs:
  yaml-schema-validation:
    name: YAML map schema validator
    if: github.actor != 'PJBot' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞
    permissions:
      contents: read
      checks: write
      pull-requests: write  # ‚Üê –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è pull_request_target
    
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ –ò–ó PR (–Ω–µ –∏–∑ —Ü–µ–ª–µ–≤–æ–π –≤–µ—Ç–∫–∏!)
      - name: Checkout PR code
        uses: actions/checkout@v4.2.2
        with:
          # –î–ª—è pull_request_target: –∫–ª–æ–Ω–∏—Ä—É–µ–º –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è PR
          repository: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}  # –ò—Å–ø–æ–ª—å–∑—É–µ–º GITHUB_TOKEN –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
          submodules: false
          
      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö PR)
      - name: Configure Git authentication for private submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN }}
        run: |
          echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ç–æ–∫–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö PR –∏–ª–∏ push)
          if [ -z "$PAT" ]; then
            echo "–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π"
            echo "–î–ª—è PR –∏–∑ —Ñ–æ—Ä–∫–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–∞"
          elif [ "${{ github.event_name }}" == "pull_request_target" ] && [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "PR –∏–∑ —Ñ–æ—Ä–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø"
            # –î–ª—è —Ñ–æ—Ä–∫–æ–≤ –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
          else
            echo "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π"
            git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"
            git config --global url."https://x-access-token:$PAT@github.com/Metro-Observers".insteadOf "https://github.com/Metro-Observers"
          fi
          
          echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Git –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
          
      # 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏
      - name: Initialize and update submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN }}
        run: |
          echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ–¥–º–æ–¥—É–ª–µ–π
          echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–º–æ–¥—É–ª–µ–π:"
          git submodule status || true
          
          # –ü—ã—Ç–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–º–æ–¥—É–ª–∏
          echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏..."
          if git submodule update --init --recursive --force --depth=1; then
            echo "–ü–æ–¥–º–æ–¥—É–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
          else
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–¥–º–æ–¥—É–ª–∏"
            echo "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–º–æ–¥—É–ª–µ–π..."
          fi
          
      # 4. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–º–æ–¥—É–ª—å RobustToolbox
      - name: Update RobustToolbox
        run: |
          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º RobustToolbox..."
          if [ -d "RobustToolbox/" ]; then
            cd RobustToolbox
            git submodule update --init --recursive
            cd ..
            echo "RobustToolbox –æ–±–Ω–æ–≤–ª–µ–Ω"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ö–µ–º—ã
            if [ -f "RobustToolbox/Schemas/mapfile.yml" ]; then
              echo "–°—Ö–µ–º–∞ mapfile.yml –Ω–∞–π–¥–µ–Ω–∞"
            else
              echo "–°—Ö–µ–º–∞ mapfile.yml –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
              exit 1
            fi
          else
            echo "RobustToolbox –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
      # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ map —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã –≤ PR
      - name: Check changed map files
        id: changed_files
        if: github.event_name == 'pull_request_target'
        run: |
          echo "üîç –ò—â–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ map —Ñ–∞–π–ª—ã –≤ PR..."
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          
          # –î–ª—è —Ñ–æ—Ä–∫–æ–≤ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ —Å—Å—ã–ª–∫–∏
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            # –î–ª—è —Ñ–æ—Ä–∫–æ–≤: –¥–æ–±–∞–≤–ª—è–µ–º remote
            git remote add pr_head "https://github.com/${{ github.event.pull_request.head.repo.full_name }}.git"
            git fetch pr_head $HEAD_REF
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF pr_head/$HEAD_REF -- "Resources/Maps/" "*.yml" "*.yaml" 2>/dev/null || echo "")
          else
            # –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö PR
            git fetch origin $BASE_REF $HEAD_REF
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF origin/$HEAD_REF -- "Resources/Maps/" "*.yml" "*.yaml" 2>/dev/null || echo "")
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "üìÑ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
            echo "$CHANGED_FILES"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          else
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ map —Ñ–∞–π–ª–∞—Ö"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          
      # 6. –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä YAML —Å—Ö–µ–º
      - name: Validate map files
        if: github.event_name != 'pull_request_target' || steps.changed_files.outputs.changed == 'true'
        uses: PaulRitter/yaml-schema-validator@v1
        with:
          schema: RobustToolbox/Schemas/mapfile.yml
          path_pattern: .*Resources/Maps/.*
          validators_path: RobustToolbox/Schemas/mapfile_validators.py
          validators_requirements: RobustToolbox/Schemas/mapfile_requirements.txt
          
      # 7. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
      - name: Skip if no map changes
        if: github.event_name == 'pull_request_target' && steps.changed_files.outputs.changed == 'false'
        run: |
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ map —Ñ–∞–π–ª–∞—Ö, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞"
