name: Map file schema validator

on:
  push:
    branches: [ master, staging, stable ]
  merge_group:
  pull_request_target:
    types: [ opened, reopened, synchronize, ready_for_review ]
  workflow_dispatch:

jobs:
  yaml-schema-validation:
    name: YAML map schema validator
    if: github.actor != 'PJBot' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
      # 1. Клонируем код ИЗ PR
      - name: Checkout PR code
        uses: actions/checkout@v4.2.2
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false
          
      # 2. Настраиваем приватные подмодули
      - name: Setup private submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN }}
        run: |
          [ -n "$PAT" ] && git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"
          git submodule update --init --recursive
          
      # 3. Проверяем что схема существует
      - name: Verify schema exists
        run: |
          if [ ! -f "RobustToolbox/Schemas/mapfile.yml" ]; then
            echo "Схема не найдена: RobustToolbox/Schemas/mapfile.yml"
            echo "Содержимое RobustToolbox/Schemas:"
            ls -la RobustToolbox/Schemas/ 2>/dev/null || echo "Директория не найдена"
            exit 1
          fi
          echo "Схема найдена"
          
      # 4. Проверяем измененные map файлы
      - name: Check changed map files
        id: changed_files
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            git remote add pr_head "https://github.com/${{ github.event.pull_request.head.repo.full_name }}.git"
            git fetch pr_head $HEAD_REF
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF pr_head/$HEAD_REF -- "Resources/Maps/" "*.yml" "*.yaml" 2>/dev/null || echo "")
          else
            git fetch origin $BASE_REF $HEAD_REF
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF origin/$HEAD_REF -- "Resources/Maps/" "*.yml" "*.yaml" 2>/dev/null || echo "")
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          
      # 5. Запускаем валидатор
      - name: Validate map files
        if: steps.changed_files.outputs.changed == 'true'
        uses: PaulRitter/yaml-schema-validator@v1
        with:
          schema: RobustToolbox/Schemas/mapfile.yml
          path_pattern: .*Resources/Maps/.*
          validators_path: RobustToolbox/Schemas/mapfile_validators.py
          validators_requirements: RobustToolbox/Schemas/mapfile_requirements.txt
          
      # 6. Пропускаем если нет изменений
      - name: Skip if no map changes
        if: steps.changed_files.outputs.changed == 'false'
        run: |
          echo "Нет изменений в map файлах"
