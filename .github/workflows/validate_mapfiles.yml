name: Map file schema validator

on:
  push:
    branches: [ master, staging, stable ]
  merge_group:
  pull_request_target:
    types: [ opened, reopened, synchronize, ready_for_review ]
  workflow_dispatch:

jobs:
  yaml-schema-validation:
    name: YAML map schema validator
    if: github.actor != 'PJBot' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ –ò–ó PR
      - name: Checkout PR code
        uses: actions/checkout@v4.2.2
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false
          
      # 2. –û—Ç–ª–∞–¥–∫–∞: —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      - name: Debug - check what we cloned
        run: |
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:"
          ls -la
          echo ""
          echo "–ü–æ–¥–º–æ–¥—É–ª–∏ –≤ .gitmodules:"
          cat .gitmodules || echo "–ù–µ—Ç .gitmodules"
          
      # 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –ø–æ–¥–º–æ–¥—É–ª–∏
      - name: Setup private submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN }}
        run: |
          echo "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º..."
          
          if [ -n "$PAT" ]; then
            git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"
            echo "–¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          else
            echo "–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π"
          fi
          
          echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏..."
          git submodule update --init --recursive || echo "–ß–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è"
          
      # 4. –ü–†–û–í–ï–†–ö–ê: –ß—Ç–æ –≤ RobustToolbox
      - name: Debug - check RobustToolbox
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º RobustToolbox..."
          if [ -d "RobustToolbox/" ]; then
            echo "RobustToolbox —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ RobustToolbox:"
            ls -la RobustToolbox/
            echo ""
            echo "–ò—â–µ–º Schemas:"
            find RobustToolbox -name "Schemas" -type d
            echo ""
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ RobustToolbox/Schemas (–µ—Å–ª–∏ –µ—Å—Ç—å):"
            ls -la RobustToolbox/Schemas/ 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è Schemas –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo ""
            echo "–ò—â–µ–º mapfile.yml:"
            find RobustToolbox -name "mapfile.yml" -o -name "mapfile.yaml"
          else
            echo "RobustToolbox –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
            echo "–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤:"
            ls -la
          fi
          
      # 5. –ò—â–µ–º —Å—Ö–µ–º—É –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
      - name: Find schema file
        id: find_schema
        run: |
          echo "–ò—â–µ–º —Å—Ö–µ–º—É mapfile..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏
          SCHEMA_PATHS=(
            "RobustToolbox/Schemas/mapfile.yml"
            "RobustToolbox/Schemas/mapfile.yaml"
            "Schemas/mapfile.yml"
            "Schemas/mapfile.yaml"
            "Content.Shared/Schemas/mapfile.yml"
          )
          
          for path in "${SCHEMA_PATHS[@]}"; do
            if [ -f "$path" ]; then
              echo "–ù–∞–π–¥–µ–Ω–∞ —Å—Ö–µ–º–∞: $path"
              echo "schema_path=$path" >> $GITHUB_OUTPUT
              break
            fi
          done
          
          if [ -z "${{ steps.find_schema.outputs.schema_path }}" ]; then
            echo "–°—Ö–µ–º–∞ mapfile –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ –≤ –æ–¥–Ω–æ–º –∏–∑ –º–µ—Å—Ç:"
            printf '  - %s\n' "${SCHEMA_PATHS[@]}"
            exit 1
          fi
          
      # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ map —Ñ–∞–π–ª—ã
      - name: Check changed map files
        id: changed_files
        run: |
          echo "üîç –ò—â–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ map —Ñ–∞–π–ª—ã..."
          
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            git remote add pr_head "https://github.com/${{ github.event.pull_request.head.repo.full_name }}.git"
            git fetch pr_head $HEAD_REF
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF pr_head/$HEAD_REF -- "Resources/Maps/" "*.yml" "*.yaml" 2>/dev/null || echo "")
          else
            git fetch origin $BASE_REF $HEAD_REF
            CHANGED_FILES=$(git diff --name-only origin/$BASE_REF origin/$HEAD_REF -- "Resources/Maps/" "*.yml" "*.yaml" 2>/dev/null || echo "")
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
            echo "$CHANGED_FILES"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ map —Ñ–∞–π–ª–∞—Ö"
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          
      # 7. –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä
      - name: Validate map files
        if: steps.changed_files.outputs.changed == 'true'
        uses: PaulRitter/yaml-schema-validator@v1
        with:
          schema: ${{ steps.find_schema.outputs.schema_path }}
          path_pattern: .*Resources/Maps/.*
          validators_path: RobustToolbox/Schemas/mapfile_validators.py
          validators_requirements: RobustToolbox/Schemas/mapfile_requirements.txt
          
      # 8. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
      - name: Skip if no map changes
        if: steps.changed_files.outputs.changed == 'false'
        run: |
          echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ map —Ñ–∞–π–ª–∞—Ö, –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞"
