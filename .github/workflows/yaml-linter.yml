name: YAML Linter

on:
  push:
    branches: [ master, staging, stable ]
  merge_group:
  pull_request_target:  # –ò—Å–ø–æ–ª—å–∑—É–µ–º pull_request_target –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ–∫—Ä–µ—Ç–∞–º
    types: [ opened, reopened, synchronize, ready_for_review ]
  workflow_dispatch:

jobs:
  build:
    name: YAML Linter
    if: github.actor != 'PJBot' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
      # 1. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ –ò–ó PR (head), –∞ –Ω–µ –≤ target
      - name: Checkout PR code
        uses: actions/checkout@v4.2.2
        with:
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è PR
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}  # –ò—Å–ø–æ–ª—å–∑—É–µ–º GITHUB_TOKEN –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          submodules: false
          
      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º —Å –Ω–∞—à–∏–º —Ç–æ–∫–µ–Ω–æ–º
      - name: Setup Git authentication for private submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN }}
        run: |
          echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º..."
          
          if [ -n "$PAT" ]; then
            git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"
            echo "–¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
          else
            echo "–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
      # 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏ –∏–∑ –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–≥–æ PR
      - name: Initialize and update submodules
        run: |
          echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏ –∏–∑ PR..."
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏
          git submodule update --init --recursive --force
          
          echo "–ü–æ–¥–º–æ–¥—É–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
          
      # 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .NET Core
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4.1.0
        with:
          dotnet-version: 10.0.x
          
      # 5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: dotnet restore
        
      # 6. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      - name: Build
        run: dotnet build --configuration Release --no-restore /p:WarningsAsErrors= /m
        
      # 7. –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–∞ YAML
      - name: Run Linter
        run: dotnet run --project Content.YAMLLinter/Content.YAMLLinter.csproj --no-build
