name: YAML Linter

on:
  push:
    branches: [ master, staging, stable ]
  merge_group:
  pull_request:
    types: [ opened, reopened, synchronize, ready_for_review ]
  workflow_dispatch:

jobs:
  build:
    name: YAML Linter
    if: github.actor != 'PJBot' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞
    permissions:
      contents: read
      checks: write
    
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - uses: actions/checkout@v4.2.2
        with:
          # –í–∞–∂–Ω–∞—è –æ–ø—Ü–∏—è –¥–ª—è –ø–æ–¥–º–æ–¥—É–ª–µ–π
          submodules: false
          
      # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º
      - name: Setup Git authentication for private submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –ø–æ–¥–º–æ–¥—É–ª—è–º..."
    
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
          if [ -z "$PAT" ]; then
            echo "–û–®–ò–ë–ö–ê: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            echo "–î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç PRIVATE_SUBMODULE_TOKEN –∏–ª–∏ ORG_ACCESS_TOKEN"
            exit 1
          fi
    
          echo "–î–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞: ${#PAT} —Å–∏–º–≤–æ–ª–æ–≤"
    
          #–í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö GitHub URL (–ø—Ä–æ—â–µ, –Ω–æ –º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
          #git config --global url."https://x-access-token:$PAT@github.com".insteadOf "https://github.com"
    
          # –í–∞—Ä–∏–∞–Ω—Ç 2: –¢–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
          git config --global url."https://x-access-token:$PAT@github.com/Metro-Observers/".insteadOf "https://github.com/Metro-Observers/"
    
          # –î–ª—è git:// –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
          git config --global url."https://github.com".insteadOf "git://github.com"
    
          echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Git –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Git:"
          git config --global --get-regexp "url.*insteadof"
          
      # 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏
      - name: Initialize and update submodules
        env:
          PAT: ${{ secrets.PRIVATE_SUBMODULE_TOKEN || secrets.ORG_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏..."
          
          # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ–¥–º–æ–¥—É–ª–µ–π
          echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–º–æ–¥—É–ª–µ–π:"
          git submodule status || true
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏ —Å —Ä–µ–∫—É—Ä—Å–∏–µ–π
          echo "–í—ã–ø–æ–ª–Ω—è–µ–º git submodule update --init --recursive..."
          git submodule update --init --recursive --force
          
          echo "–ü–æ–¥–º–æ–¥—É–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–¥–º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–º–æ–¥—É–ª–µ–π:"
          if [ -d "Content.Client/_Metro14" ] && [ -d "Content.Server/_Metro14" ] && [ -d "Content.Shared/_Metro14" ]; then
            echo "–í—Å–µ –ø–æ–¥–º–æ–¥—É–ª–∏ –Ω–∞–π–¥–µ–Ω—ã"
            echo "  - Client: $(cd Content.Client/_Metro14 && git log -1 --oneline || echo '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ')"
            echo "  - Server: $(cd Content.Server/_Metro14 && git log -1 --oneline || echo '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ')"
            echo "  - Shared: $(cd Content.Shared/_Metro14 && git log -1 --oneline || echo '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ')"
          else
            echo "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–º–æ–¥—É–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
            ls -la Content.*/_Metro14 2>/dev/null || echo "–ü–æ–¥–º–æ–¥—É–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          fi
      
      # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–º–æ–¥—É–ª—å RobustToolbox –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      - name: Update Engine Submodules
        if: false  # –û—Ç–∫–ª—é—á–∞–µ–º, –µ—Å–ª–∏ RobustToolbox –Ω–µ—Ç –∏–ª–∏ –æ–Ω –Ω–µ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
        run: |
          if [ -d "RobustToolbox/" ]; then
            echo "–û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–º–æ–¥—É–ª–∏ –¥–≤–∏–∂–∫–∞..."
            cd RobustToolbox/
            git submodule update --init --recursive
          else
            echo "RobustToolbox –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          fi
          
      # 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .NET Core
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v4.1.0
        with:
          dotnet-version: 10.0.x
          
      # 6. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        run: dotnet restore
        
      # 7. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      - name: Build
        run: dotnet build --configuration Release --no-restore /p:WarningsAsErrors= /m
        
      # 8. –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–∞ YAML
      - name: Run Linter
        run: dotnet run --project Content.YAMLLinter/Content.YAMLLinter.csproj --no-build
